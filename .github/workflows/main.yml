name: Cherry-pick with PR on Conflict

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Branch to cherry-pick from'
        required: true
        default: 'feature-branch'
      target_branch:
        description: 'Branch to cherry-pick to'
        required: true
        default: 'main'
      commit_sha:
        description: 'Commit SHA to cherry-pick'
        required: true

jobs:
  cherry-pick:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Fetch all branches
      run: git fetch origin

    - name: Checkout target branch
      run: |
        git checkout ${{ github.event.inputs.target_branch }}
        git pull origin ${{ github.event.inputs.target_branch }}

    - name: Create temp branch
      run: |
        TIMESTAMP=$(date +%s)
        export BRANCH_NAME=cherry-pick-${{ github.event.inputs.commit_sha }}-$TIMESTAMP
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        git checkout -b $BRANCH_NAME

    - name: Try cherry-pick commit
      id: cherry
      continue-on-error: true
      run: |
        git cherry-pick ${{ github.event.inputs.commit_sha }}

    - name: Commit conflict markers if needed
      if: steps.cherry.outcome == 'failure'
      run: |
        echo "Cherry-pick failed. Keeping conflict markers and committing partial changes..."
        git add .
        git commit -m "Conflict during cherry-pick of ${{ github.event.inputs.commit_sha }}"

    - name: Push branch
      run: |
        git push origin $BRANCH_NAME

    - name: Create pull request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ env.BRANCH_NAME }}
        base: ${{ github.event.inputs.target_branch }}
        title: "ðŸ§© Cherry-pick ${{ github.event.inputs.commit_sha }} with conflict"
        body: |
          This PR was auto-created due to a cherry-pick conflict.

          Please resolve the conflict in `README.md` (or other files), commit the resolution, and merge.

          - Commit: `${{ github.event.inputs.commit_sha }}`
          - Source Branch: `${{ github.event.inputs.source_branch}}`
          - Target Branch: `${{ github.event.inputs.target_branch}}`
